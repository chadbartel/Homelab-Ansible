---
# Configure a single VPN user (called via loop from users.yml)

- name: Check if user exists
  ansible.builtin.set_fact:
    user_exists: "{{ user.username in existing_users.stdout_lines }}"

- name: Create VPN user - {{ user.username }}
  docker_swarm_container_exec:
    container_id: "{{ openvpn_container_id.stdout }}"
    command: "sacli --user '{{ user.username }}' --key 'type' --value 'user_connect' UserPropPut"
  register: user_create_result
  delegate_to: "{{ openvpn_config_target_host }}"
  retries: 3
  delay: 5
  until: user_create_result.rc == 0
  when: not user_exists

- name: Set password for user - {{ user.username }}
  docker_swarm_container_exec:
    container_id: "{{ openvpn_container_id.stdout }}"
    command: "sacli --user '{{ user.username }}' --new_pass '{{ user.password }}' SetLocalPassword"
  register: user_password_result
  delegate_to: "{{ openvpn_config_target_host }}"
  retries: 3
  delay: 5
  until: user_password_result.rc == 0
  no_log: true  # Don't log password

- name: Configure auto-login for user - {{ user.username }}
  docker_swarm_container_exec:
    container_id: "{{ openvpn_container_id.stdout }}"
    command: "sacli --user '{{ user.username }}' --key 'prop_autologin' --value '{{ user.autologin | default(false) | lower }}' UserPropPut"
  register: user_autologin_result
  delegate_to: "{{ openvpn_config_target_host }}"
  retries: 3
  delay: 5
  until: user_autologin_result.rc == 0
  when: user.autologin is defined

- name: Display user configuration status
  ansible.builtin.debug:
    msg: |
      {% if user_exists %}
      ↻ User '{{ user.username }}' already exists - password updated
      {% else %}
      ✓ User '{{ user.username }}' created
      {% endif %}
      - Auto-login: {{ user.autologin | default(false) }}
