---
# User Management Tasks - Create and configure VPN users (Idempotent)

- name: Get list of existing OpenVPN users
  ansible.builtin.shell: |
    docker exec {{ openvpn_container_id.stdout }} \
      sacli UserPropGet 2>/dev/null | grep -E "^[a-zA-Z0-9_-]+$" || echo ""
  register: existing_users
  delegate_to: "{{ openvpn_config_target_host }}"
  changed_when: false
  failed_when: false

- name: Display existing users
  ansible.builtin.debug:
    msg: "Existing OpenVPN users: {{ existing_users.stdout_lines }}"

- name: Configure VPN users
  delegate_to: "{{ openvpn_config_target_host }}"
  loop: "{{ openvpn_config_users }}"
  loop_control:
    loop_var: user
    label: "{{ user.username }}"
  block:
    - name: Check if user exists
      ansible.builtin.set_fact:
        user_exists: "{{ user.username in existing_users.stdout_lines }}"

    - name: Create VPN user - {{ user.username }}
      ansible.builtin.shell: |
        docker exec {{ openvpn_container_id.stdout }} \
          sacli --user "{{ user.username }}" --key "type" --value "user_connect" UserPropPut
      register: user_create_result
      retries: 3
      delay: 5
      until: user_create_result.rc == 0
      when: not user_exists
      changed_when: true

    - name: Set password for user - {{ user.username }}
      ansible.builtin.shell: |
        docker exec {{ openvpn_container_id.stdout }} \
          sacli --user "{{ user.username }}" --new_pass "{{ user.password }}" SetLocalPassword
      register: user_password_result
      retries: 3
      delay: 5
      until: user_password_result.rc == 0
      no_log: true  # Don't log password
      changed_when: true

    - name: Configure auto-login for user - {{ user.username }}
      ansible.builtin.shell: |
        docker exec {{ openvpn_container_id.stdout }} \
          sacli --user "{{ user.username }}" --key "prop_autologin" \
          --value "{{ user.autologin | default(false) | lower }}" UserPropPut
      register: user_autologin_result
      retries: 3
      delay: 5
      until: user_autologin_result.rc == 0
      when: user.autologin is defined
      changed_when: true

    - name: Display user configuration status
      ansible.builtin.debug:
        msg: |
          {% if user_exists %}
          ↻ User '{{ user.username }}' already exists - password updated
          {% else %}
          ✓ User '{{ user.username }}' created
          {% endif %}
          - Auto-login: {{ user.autologin | default(false) }}

- name: Get final list of OpenVPN users
  ansible.builtin.shell: |
    docker exec {{ openvpn_container_id.stdout }} \
      sacli UserPropGet 2>/dev/null | grep -E "^[a-zA-Z0-9_-]+$" || echo ""
  register: final_users
  delegate_to: "{{ openvpn_config_target_host }}"
  changed_when: false
  failed_when: false

- name: Display user management summary
  ansible.builtin.debug:
    msg: |
      VPN User Management Complete:
      - Total users configured: {{ openvpn_config_users | length }}
      - Current users in system: {{ final_users.stdout_lines | length }}
      - Users: {{ final_users.stdout_lines | join(', ') }}
