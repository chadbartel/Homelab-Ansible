---
# Pi-hole service readiness check task
#
# Waits for Pi-hole web interface and FTL service to be fully initialized
# Now using the common wait_for_swarm_service task for consistency
#
# Usage:
#   - include_tasks: wait_for_service.yml
#     vars:
#       target_host: "{{ ansible_host }}"  # Optional override

- name: Ensure container facts are available
  ansible.builtin.include_tasks: discover_container.yml
  when: pihole_container_id is not defined

- name: Wait for Pi-hole service using common task
  ansible.builtin.include_tasks: tasks/common/wait_for_swarm_service.yml
  vars:
    service_name: "{{ pihole_config_service_name }}"
    wait_host: "{{ target_host | default(ansible_host) }}"
    wait_port: "{{ pihole_config_web_port }}"
    wait_delay: 15
    wait_timeout: "{{ pihole_config_readiness_timeout }}"
    wait_path: "/admin"
    wait_swarm_manager: "{{ pihole_config_swarm_manager }}"
    wait_custom_command: "pihole status"
    wait_container_id: "{{ pihole_container_id }}"
    wait_delegate_to: "{{ pihole_config_target_node }}"
    wait_custom_until_condition: "'Pi-hole blocking is enabled' in wait_custom_result.stdout or 'enabled' in wait_custom_result.stdout"
    wait_custom_retries: "{{ pihole_config_ftl_retries }}"
    wait_custom_delay: "{{ pihole_config_ftl_delay }}"
    wait_display_results: "{{ pihole_config_display_results | default(true) }}"
