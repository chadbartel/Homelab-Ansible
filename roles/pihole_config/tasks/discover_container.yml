---
# Pi-hole container discovery task
#
# This task discovers the Pi-hole container running in Docker Swarm and sets facts
# about its location and ID for use in subsequent tasks.
#
# Sets the following facts:
#   - pihole_task_id: Swarm task ID
#   - pihole_node_name: Swarm node hostname where container is running
#   - pihole_container_id: Docker container ID (short 12-char format)
#
# Usage:
#   - include_tasks: discover_container.yml

- name: Get Pi-hole task ID from Swarm service
  ansible.builtin.shell: |
    docker service ps {{ pihole_config_service_name }} \
      --filter 'desired-state=running' \
      --format '{%raw%}{{.ID}}{%endraw%}' \
      --no-trunc | head -n 1
  register: pihole_task_id_result
  changed_when: false
  failed_when: pihole_task_id_result.stdout == ""
  delegate_to: "{{ pihole_config_swarm_manager }}"

- name: Get Pi-hole node name from Swarm service
  ansible.builtin.shell: |
    docker service ps {{ pihole_config_service_name }} \
      --filter 'desired-state=running' \
      --format '{%raw%}{{.Node}}{%endraw%}' | head -n 1
  register: pihole_node_name_result
  changed_when: false
  failed_when: pihole_node_name_result.stdout == ""
  delegate_to: "{{ pihole_config_swarm_manager }}"

- name: Get Pi-hole container ID from Swarm task
  ansible.builtin.shell: |
    TASK_ID="{{ pihole_task_id_result.stdout }}"
    docker inspect "${TASK_ID}" \
      --format '{%raw%}{{.Status.ContainerStatus.ContainerID}}{%endraw%}' | head -c 12
  register: pihole_container_id_result
  changed_when: false
  failed_when: pihole_container_id_result.stdout == ""
  delegate_to: "{{ pihole_config_swarm_manager }}"

- name: Set Pi-hole container facts
  ansible.builtin.set_fact:
    pihole_task_id: "{{ pihole_task_id_result.stdout }}"
    pihole_node_name: "{{ pihole_node_name_result.stdout }}"
    pihole_container_id: "{{ pihole_container_id_result.stdout }}"
    cacheable: true

- name: Display Pi-hole container information
  ansible.builtin.debug:
    msg: |
      Pi-hole Container Discovery:
      ├─ Task ID: {{ pihole_task_id }}
      ├─ Swarm Node: {{ pihole_node_name }}
      └─ Container ID: {{ pihole_container_id }}
  when: pihole_config_display_results | default(true)
