---
# Jellyfin startup wizard completion task
#
# Completes the initial Jellyfin setup wizard in an idempotent way.
# Only runs if the wizard has not been completed.
#
# Required variables:
#   - jellyfin_config_admin_user: Admin username
#   - jellyfin_config_admin_password: Admin password
#
# Usage:
#   - include_tasks: setup_wizard.yml
#     vars:
#       target_url: "http://127.0.0.1:8096"  # Optional override

- name: Set target Jellyfin URL
  ansible.builtin.set_fact:
    jellyfin_target_url: "{{ target_url | default('http://127.0.0.1:' + (jellyfin_config_web_port | string)) }}"

- name: Check if setup wizard has been completed (via /Startup/Configuration endpoint)
  ansible.builtin.uri:
    url: "{{ jellyfin_target_url }}/Startup/Configuration"
    method: GET
    status_code: [200, 401, 404]
    validate_certs: "{{ jellyfin_config_validate_certs }}"
  register: jellyfin_startup_check
  failed_when: false

- name: Try to authenticate to verify user exists (better wizard completion check)
  ansible.builtin.uri:
    url: "{{ jellyfin_target_url }}/Users/AuthenticateByName"
    method: POST
    headers:
      X-Emby-Authorization: 'MediaBrowser Client="Ansible", Device="Homelab-Ansible", DeviceId="ansible-{{ inventory_hostname }}", Version="1.0.0"'
      Content-Type: "application/json"
    body_format: json
    body:
      Username: "{{ jellyfin_config_admin_user }}"
      Pw: "{{ jellyfin_config_admin_password }}"
    status_code: [200, 400, 401, 404]
    validate_certs: "{{ jellyfin_config_validate_certs }}"
  register: jellyfin_wizard_auth_check
  failed_when: false
  when: jellyfin_startup_check.status != 200

- name: Determine if wizard needs to be run
  ansible.builtin.set_fact:
    wizard_needs_completion: "{{ jellyfin_startup_check.status == 200 or (jellyfin_wizard_auth_check.status | default(0)) == 404 }}"

- name: Display setup wizard status
  ansible.builtin.debug:
    msg: |
      {% if wizard_needs_completion %}
      ⚙️ Setup wizard needs completion
      Reason: {% if jellyfin_startup_check.status == 200 %}Startup endpoint returned 200{% else %}User authentication returned 404 (user doesn't exist){% endif %}
      {% else %}
      ✅ Setup wizard already completed
      Startup endpoint: {{ jellyfin_startup_check.status }}
      {% if jellyfin_wizard_auth_check is defined %}Auth check: {{ jellyfin_wizard_auth_check.status }}{% endif %}
      {% endif %}
  when: jellyfin_config_display_results | default(true)

- name: Complete Jellyfin startup wizard - Set UI culture
  ansible.builtin.uri:
    url: "{{ jellyfin_target_url }}/Startup/Configuration"
    method: POST
    body_format: json
    body:
      ServerName: "{{ jellyfin_config_server_name }}"
      UICulture: "{{ jellyfin_config_ui_culture }}"
      MetadataCountryCode: "{{ jellyfin_config_metadata_country }}"
      PreferredMetadataLanguage: "{{ jellyfin_config_preferred_metadata_language }}"
    status_code: [200, 204]
    validate_certs: "{{ jellyfin_config_validate_certs }}"
  when: wizard_needs_completion
  failed_when: false
  register: wizard_config

- name: Complete Jellyfin startup wizard - Configure remote access
  ansible.builtin.uri:
    url: "{{ jellyfin_target_url }}/Startup/RemoteAccess"
    method: POST
    body_format: json
    body:
      EnableRemoteAccess: "{{ jellyfin_config_disable_remote_access | bool }}"
    status_code: [200, 204]
    validate_certs: "{{ jellyfin_config_validate_certs }}"
  when: wizard_needs_completion
  failed_when: false
  register: wizard_remote

- name: Validate admin credentials are provided
  ansible.builtin.assert:
    that:
      - jellyfin_config_admin_user is defined
      - jellyfin_config_admin_user | length > 0
      - jellyfin_config_admin_password is defined
      - jellyfin_config_admin_password | length > 0
    fail_msg: "Admin credentials not provided. Set jellyfin_config_admin_user and jellyfin_config_admin_password"
    success_msg: "Admin credentials validated"
  when: wizard_needs_completion

- name: Complete Jellyfin startup wizard - Create admin user
  ansible.builtin.uri:
    url: "{{ jellyfin_target_url }}/Startup/User"
    method: POST
    body_format: json
    body:
      Name: "{{ jellyfin_config_admin_user }}"
      Password: "{{ jellyfin_config_admin_password }}"
    status_code: [200, 204]
    validate_certs: "{{ jellyfin_config_validate_certs }}"
  when: wizard_needs_completion
  failed_when: false
  register: wizard_user

- name: Complete Jellyfin startup wizard - Finalize setup
  ansible.builtin.uri:
    url: "{{ jellyfin_target_url }}/Startup/Complete"
    method: POST
    body_format: json
    body: {}
    status_code: [200, 204]
    validate_certs: "{{ jellyfin_config_validate_certs }}"
  when: wizard_needs_completion
  failed_when: false
  register: wizard_complete

- name: Wait for wizard completion to settle
  ansible.builtin.pause:
    seconds: 10
    prompt: "Waiting for setup wizard completion to settle..."
  when:
    - wizard_needs_completion
    - wizard_complete is changed

- name: Display wizard completion status
  ansible.builtin.debug:
    msg: |
      {% if wizard_needs_completion %}
      ✅ Jellyfin setup wizard completed successfully
      Server Name: {{ jellyfin_config_server_name }}
      Admin User: {{ jellyfin_config_admin_user }}
      {% else %}
      ℹ️ Wizard was already completed, skipping
      {% endif %}
  when: jellyfin_config_display_results | default(true)
