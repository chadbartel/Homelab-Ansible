---
# Jellyfin service readiness check task
#
# Waits for Jellyfin web interface to be fully initialized and ready for configuration
# Now using the common wait_for_swarm_service task for consistency
#
# Usage:
#   - include_tasks: wait_for_service.yml
#     vars:
#       target_host: "{{ ansible_host }}"  # Optional override

- name: Ensure container facts are available
  ansible.builtin.include_tasks: discover_container.yml
  when: jellyfin_container_id is not defined

- name: Wait for Jellyfin service using common task
  ansible.builtin.include_tasks: tasks/common/wait_for_swarm_service.yml
  vars:
    service_name: "{{ jellyfin_config_service_name }}"
    wait_host: "{{ target_host | default(ansible_host) }}"
    wait_port: "{{ jellyfin_config_web_port }}"
    wait_initial_pause: "{{ jellyfin_config_startup_wait }}"
    wait_delay: 10
    wait_timeout: "{{ jellyfin_config_readiness_timeout }}"
    wait_path: "/health"
    wait_http_status_codes: [200, 204, 503]  # 503 is OK during startup
    wait_swarm_manager: "{{ jellyfin_config_swarm_manager }}"
    wait_display_results: "{{ jellyfin_config_display_results | default(true) }}"

- name: Check Jellyfin container logs for errors
  ansible.builtin.shell: |
    docker logs --tail 50 {{ jellyfin_container_id }} 2>&1
  register: jellyfin_logs
  changed_when: false
  failed_when: false
  delegate_to: "{{ jellyfin_config_target_node }}"

- name: Validate no fatal errors in logs
  ansible.builtin.assert:
    that:
      - "'readonly database' not in jellyfin_logs.stdout"
    fail_msg: "❌ Jellyfin has fatal errors - check logs"
    success_msg: "✅ No fatal errors detected in Jellyfin logs"
  failed_when: false
  when: jellyfin_config_display_results | default(true)
