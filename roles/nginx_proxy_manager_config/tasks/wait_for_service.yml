---
# Wait for NPM service to be ready
# This ensures the API is accessible before attempting configuration

- name: Wait for NPM web interface to be accessible
  ansible.builtin.wait_for:
    host: "{{ hostvars[npm_config_target_node]['ansible_host'] }}"
    port: "{{ npm_config_web_port }}"
    delay: "{{ npm_config_readiness_delay }}"
    timeout: "{{ npm_config_readiness_timeout }}"
  delegate_to: localhost
  become: false

- name: Verify NPM API is responding
  ansible.builtin.uri:
    url: "http://{{ hostvars[npm_config_target_node]['ansible_host'] }}:{{ npm_config_web_port }}/api"
    method: GET
    status_code: [200, 401]  # 401 is OK, means API is up but not authenticated
    timeout: 10
  register: npm_api_check
  retries: "{{ npm_config_readiness_retries }}"
  delay: "{{ npm_config_readiness_delay }}"
  until: npm_api_check.status in [200, 401]
  become: false

- name: Display NPM service status
  ansible.builtin.debug:
    msg: "NPM API is ready at http://{{ hostvars[npm_config_target_node]['ansible_host'] }}:{{ npm_config_web_port }}"
