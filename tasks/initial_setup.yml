---
# Initial system setup tasks
- name: Update apt package cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600

- name: Add deadsnakes repository
  ansible.builtin.apt_repository:
    repo: "ppa:deadsnakes/ppa"
    state: present
    filename: deadsnakes
  when:
    - ansible_distribution == "Ubuntu"
    - ansible_architecture == "x86_64"

- name: Update apt package cache, again
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600
  when:
    - ansible_distribution == "Ubuntu"
    - ansible_architecture == "x86_64"

- name: Install essential packages
  ansible.builtin.apt:
    name:
      - curl
      - wget
      - git
      - htop
      - vim
      - unzip
      - ca-certificates
      - gnupg
      - lsb-release
      - python3-pip
      - python3-venv
      - "python{{ python_version }}"
      - "python{{ python_version }}-venv"
      - "python{{ python_version }}-dev"
    state: present

- name: Create Python virtual environment directory
  ansible.builtin.file:
    path: "{{ python_venv_path }}"
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Create Python virtual environment
  ansible.builtin.command:
    cmd: "python{{ python_version }} -m venv {{ python_venv_path }}"
    creates: "{{ python_venv_path }}/bin/activate"
  register: venv_created

- name: Upgrade pip in virtual environment
  ansible.builtin.pip:
    name: pip
    state: latest
    virtualenv: "{{ python_venv_path }}"
    virtualenv_command: "python{{ python_version }} -m venv"

- name: Install Python packages in virtual environment
  ansible.builtin.pip:
    name: "{{ python_packages }}"
    state: present
    virtualenv: "{{ python_venv_path }}"
    virtualenv_command: "python{{ python_version }} -m venv"

- name: Create symbolic link for system-wide access to venv python
  ansible.builtin.file:
    src: "{{ python_venv_path }}/bin/python"
    dest: "/usr/local/bin/ansible-python"
    state: link
    force: true

- name: Display virtual environment info
  ansible.builtin.debug:
    msg: |
      ‚úÖ Python virtual environment created:
      Path: {{ python_venv_path }}
      Python: {{ python_venv_path }}/bin/python
      Pip: {{ python_venv_path }}/bin/pip
      Packages installed: {{ python_packages | join(', ') }}

- name: Create admin user
  ansible.builtin.user:
    name: "{{ admin_user }}"
    comment: "Admin User"
    groups: sudo
    state: present
    shell: /bin/bash
    password: "{{ admin_password | password_hash('sha512') }}"
  when: 
    - ansible_user != admin_user
    - admin_password | length > 0

- name: Set up SSH key authentication
  ansible.posix.authorized_key:
    user: "{{ admin_user }}"
    state: present
    key: "{{ admin_ssh_key_public }}"
  when: admin_ssh_key_public | length > 0

- name: Configure SSH security
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    backup: true
  loop:
    - regexp: '^#?PasswordAuthentication'
      line: "PasswordAuthentication no"
    - regexp: '^#?PermitRootLogin'
      line: "PermitRootLogin no"
  notify: restart ssh

- name: Set timezone
  community.general.timezone:
    name: "{{ timezone }}"

- name: Create Pi-hole data directory
  ansible.builtin.file:
    path: "{{ pihole_data_path }}"
    state: directory
    mode: '0755'
    owner: root
    group: root

# ========================================
# GPU Setup for lenovo_server
# ========================================
- name: Detect GPU type on lenovo_server
  ansible.builtin.shell: |
    if lspci | grep -i 'VGA.*Intel' > /dev/null; then
      echo "intel"
    elif lspci | grep -i 'VGA.*NVIDIA' > /dev/null; then
      echo "nvidia"
    elif lspci | grep -i 'VGA.*AMD\|ATI' > /dev/null; then
      echo "amd"
    else
      echo "none"
    fi
  register: gpu_type
  changed_when: false
  when: inventory_hostname == 'lenovo_server'

- name: Display detected GPU type
  ansible.builtin.debug:
    msg: "Detected GPU type: {{ gpu_type.stdout }}"
  when: inventory_hostname == 'lenovo_server'

- name: Install Intel GPU drivers and tools
  ansible.builtin.apt:
    name:
      - intel-gpu-tools
      - intel-media-va-driver
      - vainfo
      - i965-va-driver
    state: present
    update_cache: yes
  when:
    - inventory_hostname == 'lenovo_server'
    - gpu_type.stdout == 'intel'

- name: Install NVIDIA GPU drivers
  ansible.builtin.apt:
    name:
      - nvidia-driver-535
      - nvidia-utils-535
    state: present
    update_cache: yes
  when:
    - inventory_hostname == 'lenovo_server'
    - gpu_type.stdout == 'nvidia'
  register: nvidia_driver_installed

- name: Install NVIDIA Container Toolkit repository
  ansible.builtin.shell: |
    distribution=$(. /etc/os-release;echo $ID$VERSION_ID)
    curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg
    curl -s -L https://nvidia.github.io/libnvidia-container/$distribution/libnvidia-container.list | \
      sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' | \
      tee /etc/apt/sources.list.d/nvidia-container-toolkit.list
  when:
    - inventory_hostname == 'lenovo_server'
    - gpu_type.stdout == 'nvidia'
  changed_when: true

- name: Install NVIDIA Container Toolkit
  ansible.builtin.apt:
    name: nvidia-container-toolkit
    state: present
    update_cache: yes
  when:
    - inventory_hostname == 'lenovo_server'
    - gpu_type.stdout == 'nvidia'
  notify: restart docker

- name: Install AMD GPU drivers and tools
  ansible.builtin.apt:
    name:
      - mesa-va-drivers
      - vainfo
      - radeontop
    state: present
    update_cache: yes
  when:
    - inventory_hostname == 'lenovo_server'
    - gpu_type.stdout == 'amd'

- name: Add admin user to video and render groups for GPU access
  ansible.builtin.user:
    name: "{{ admin_user }}"
    groups: video,render
    append: yes
  when: inventory_hostname == 'lenovo_server'

- name: Verify /dev/dri exists after driver installation
  ansible.builtin.stat:
    path: /dev/dri
  register: dri_check
  when: inventory_hostname == 'lenovo_server'

- name: Display GPU device status
  ansible.builtin.debug:
    msg: "{{ '‚úÖ /dev/dri exists - GPU acceleration available' if dri_check.stat.exists else '‚ö†Ô∏è /dev/dri missing - reboot may be required or no GPU detected' }}"
  when: inventory_hostname == 'lenovo_server'

- name: Get render group GID
  ansible.builtin.shell: |
    getent group render | cut -d: -f3
  register: render_gid
  changed_when: false
  failed_when: false
  when: inventory_hostname == 'lenovo_server'

- name: Get video group GID
  ansible.builtin.shell: |
    getent group video | cut -d: -f3
  register: video_gid
  changed_when: false
  failed_when: false
  when: inventory_hostname == 'lenovo_server'

- name: Set facts for GPU group GIDs
  ansible.builtin.set_fact:
    render_group_gid: "{{ render_gid.stdout }}"
    video_group_gid: "{{ video_gid.stdout }}"
  when:
    - inventory_hostname == 'lenovo_server'
    - render_gid.stdout is defined
    - video_gid.stdout is defined

- name: Display group GIDs for Jellyfin configuration
  ansible.builtin.debug:
    msg: |
      üìã Group IDs for GPU access:
      Render group GID: {{ render_gid.stdout | default('not found') }}
      Video group GID: {{ video_gid.stdout | default('not found') }}
      
      üí° These will be used in Jellyfin Docker configuration
  when: inventory_hostname == 'lenovo_server'

- name: Restart Docker service after GPU driver installation
  ansible.builtin.systemd:
    name: docker
    state: restarted
  when:
    - inventory_hostname == 'lenovo_server'
    - dri_check.stat.exists
  register: docker_restarted