---
# Pi-hole post-deployment configuration tasks
# ========================================
# PHASE 1: Service Verification
# ========================================
- name: Verify Pi-hole service exists
  ansible.builtin.shell: |
    docker service ls --filter "name=pihole-stack_pihole" --format '{% raw %}{{.Name}}{% endraw %}'
  register: pihole_service_check
  changed_when: false
  failed_when: false

- name: Check if service failed to start
  ansible.builtin.shell: |
    docker service ps pihole-stack_pihole --format '{% raw %}{{.Name}}\t{{.CurrentState}}\t{{.Error}}{% endraw %}' 2>&1 || echo "Service not found"
  register: pihole_service_debug
  changed_when: false
  failed_when: false
  when: pihole_service_check.stdout == ""

- name: Display service creation issue
  ansible.builtin.debug:
    msg: |
      ‚ö†Ô∏è Pi-hole service not found or failed to start!
      
      Diagnostic info:
      {{ pihole_service_debug.stdout }}
      
      This usually means:
      1. Stack deployment via Portainer failed
      2. Service configuration has errors (check Portainer logs)
      3. Port conflicts (port 53, 8081 might be in use)
      
      Next steps:
      - Check Portainer UI for pihole-stack deployment status
      - Review stack logs in Portainer
      - Verify ports are not already bound on {{ pihole_target_host }}
  when: pihole_service_check.stdout == ""

- name: Fail if service doesn't exist
  ansible.builtin.fail:
    msg: "Pi-hole service does not exist - check Portainer for deployment errors"
  when: pihole_service_check.stdout == ""

- name: Get Pi-hole service status
  ansible.builtin.shell: |
    docker service ps pihole-stack_pihole --format '{% raw %}{{.Name}}\t{{.Node}}\t{{.CurrentState}}\t{{.Error}}{% endraw %}'
  register: pihole_service_status
  changed_when: false

- name: Display Pi-hole service status
  ansible.builtin.debug:
    msg: |
      üìä Pi-hole Service Status:
      {{ pihole_service_status.stdout_lines | join('\n      ') }}

- name: Check if Pi-hole is running on correct node
  ansible.builtin.shell: |
    docker service ps pihole-stack_pihole --filter "desired-state=running" --format '{% raw %}{{.Node}}{% endraw %}'
  register: pihole_node
  changed_when: false

- name: Verify Pi-hole is running
  ansible.builtin.assert:
    that:
      - pihole_node.stdout != ""
    fail_msg: "ERROR: Pi-hole is not running! Check service status above."
    success_msg: "‚úÖ Pi-hole service is running on {{ pihole_node.stdout }}"

- name: Get Pi-hole container ID using service inspect (more reliable than docker ps)
  ansible.builtin.shell: |
    # Get the task ID from the running service
    TASK_ID=$(docker service ps pihole-stack_pihole --filter 'desired-state=running' --format '{% raw %}{{.ID}}{% endraw %}' --no-trunc | head -n 1)
    if [ -z "$TASK_ID" ]; then
      echo ""
      exit 0
    fi
    # Get container ID from the task
    docker inspect "${TASK_ID}" --format '{% raw %}{{.Status.ContainerStatus.ContainerID}}{% endraw %}' 2>/dev/null | head -c 12 || echo ""
  register: pihole_container_id
  changed_when: false
  failed_when: false

- name: Verify container ID was found
  ansible.builtin.assert:
    that:
      - pihole_container_id.stdout != ""
    fail_msg: |
      ‚ùå Could not get Pi-hole container ID from Swarm.
      Service is running but container ID lookup failed.
      Check 'docker service ps pihole-stack_pihole' manually.
    success_msg: "‚úÖ Found Pi-hole container: {{ pihole_container_id.stdout }}"

- name: Display Pi-hole container information
  ansible.builtin.debug:
    msg: |
      Pi-hole container ID: {{ pihole_container_id.stdout }}
      Running on node: {{ pihole_node.stdout }}

- name: Wait for Pi-hole FTL to be fully initialized
  ansible.builtin.shell: |
    docker exec {{ pihole_container_id.stdout }} pihole status
  register: pihole_status
  until: "'Pi-hole blocking is enabled' in pihole_status.stdout or 'enabled' in pihole_status.stdout"
  retries: 12
  delay: 10
  changed_when: false

- name: Create adlist configuration script
  ansible.builtin.copy:
    content: |
      #!/bin/bash
      # Add adlists to Pi-hole gravity database
      DB="/etc/pihole/gravity.db"
      
      # Array of adlists with comments
      declare -A ADLISTS=(
        ["https://raw.githubusercontent.com/PolishFiltersTeam/KADhosts/master/KADhosts.txt"]="KADhosts"
        ["https://raw.githubusercontent.com/FadeMind/hosts.extras/master/add.Spam/hosts"]="Spam Hosts"
        ["https://v.firebog.net/hosts/static/w3kbl.txt"]="W3KBL"
        ["https://adaway.org/hosts.txt"]="AdAway"
        ["https://v.firebog.net/hosts/AdguardDNS.txt"]="AdGuard DNS"
        ["https://v.firebog.net/hosts/Admiral.txt"]="Admiral"
        ["https://raw.githubusercontent.com/anudeepND/blacklist/master/adservers.txt"]="Anudeep AdServers"
        ["https://v.firebog.net/hosts/Easylist.txt"]="EasyList"
        ["https://pgl.yoyo.org/adservers/serverlist.php?hostformat=hosts&showintro=0&mimetype=plaintext"]="Peter Lowe's List"
        ["https://raw.githubusercontent.com/FadeMind/hosts.extras/master/UncheckyAds/hosts"]="UncheckyAds"
        ["https://raw.githubusercontent.com/bigdargon/hostsVN/master/hosts"]="HostsVN"
        ["https://v.firebog.net/hosts/Easyprivacy.txt"]="EasyPrivacy"
        ["https://v.firebog.net/hosts/Prigent-Ads.txt"]="Prigent Ads"
        ["https://raw.githubusercontent.com/FadeMind/hosts.extras/master/add.2o7Net/hosts"]="2o7Net"
        ["https://raw.githubusercontent.com/crazy-max/WindowsSpyBlocker/master/data/hosts/spy.txt"]="WindowsSpyBlocker"
        ["https://hostfiles.frogeye.fr/firstparty-trackers-hosts.txt"]="Firstparty Trackers"
        ["https://raw.githubusercontent.com/DandelionSprout/adfilt/master/Alternate%20versions%20Anti-Malware%20List/AntiMalwareHosts.txt"]="Anti-Malware"
        ["https://v.firebog.net/hosts/Prigent-Crypto.txt"]="Prigent Crypto"
        ["https://raw.githubusercontent.com/FadeMind/hosts.extras/master/add.Risk/hosts"]="Risk Hosts"
        ["https://bitbucket.org/ethanr/dns-blacklists/raw/8575c9f96e5b4a1308f2f12394abd86d0927a4a0/bad_lists/Mandiant_APT1_Report_Appendix_D.txt"]="Mandiant APT1"
        ["https://phishing.army/download/phishing_army_blocklist_extended.txt"]="Phishing Army"
        ["https://gitlab.com/quidsup/notrack-blocklists/raw/master/notrack-malware.txt"]="NoTrack Malware"
        ["https://v.firebog.net/hosts/RPiList-Malware.txt"]="RPiList Malware"
        ["https://raw.githubusercontent.com/Spam404/lists/master/main-blacklist.txt"]="Spam404"
        ["https://raw.githubusercontent.com/AssoEchap/stalkerware-indicators/master/generated/hosts"]="Stalkerware"
        ["https://urlhaus.abuse.ch/downloads/hostfile/"]="URLhaus"
        ["https://lists.cyberhost.uk/malware.txt"]="Cyberhost Malware"
      )
      
      for url in "${!ADLISTS[@]}"; do
        comment="${ADLISTS[$url]}"
        
        # Check if adlist already exists using pihole-FTL's sqlite3
        EXISTS=$(pihole-FTL sqlite3 "$DB" "SELECT COUNT(*) FROM adlist WHERE address='$url';" 2>/dev/null || echo "0")
        
        if [ "$EXISTS" = "0" ]; then
          # Insert new adlist
          TIMESTAMP=$(date +%s)
          pihole-FTL sqlite3 "$DB" "INSERT INTO adlist (address, enabled, comment, date_added, date_modified) VALUES ('$url', 1, '$comment', $TIMESTAMP, $TIMESTAMP);"
          if [ $? -eq 0 ]; then
            echo "Added: $comment"
          else
            echo "Failed to add: $comment"
          fi
        else
          echo "Already exists: $comment"
        fi
      done
      
      echo ""
      echo "Total adlists in database:"
      pihole-FTL sqlite3 "$DB" "SELECT COUNT(*) FROM adlist WHERE enabled=1;"
    dest: /tmp/configure_adlists.sh
    mode: '0755'

- name: Copy adlist script to Pi-hole container
  ansible.builtin.shell: |
    docker cp /tmp/configure_adlists.sh {{ pihole_container_id.stdout }}:/tmp/configure_adlists.sh

- name: Configure Pi-hole adlists (block lists)
  ansible.builtin.shell: |
    docker exec {{ pihole_container_id.stdout }} bash /tmp/configure_adlists.sh
  register: adlist_config
  changed_when: "'Added:' in adlist_config.stdout"

- name: Display adlist configuration results
  ansible.builtin.debug:
    msg: |
      Adlist configuration:
      {{ adlist_config.stdout_lines | join('\n') }}

- name: Update Pi-hole gravity (download and process block lists)
  ansible.builtin.shell: |
    docker exec {{ pihole_container_id.stdout }} pihole -g
  register: gravity_update
  changed_when: "'Update complete' in gravity_update.stdout"

- name: Display gravity update results
  ansible.builtin.debug:
    msg: |
      Gravity update completed:
      {{ gravity_update.stdout_lines | join('\n') }}

- name: Configure custom DNS entries for local domains
  ansible.builtin.shell: |
    docker exec {{ pihole_container_id.stdout }} bash -c '
    cat > /etc/pihole/custom.list << EOF
    {{ manager_node_ip }} {{ heimdall_container_name }}.{{ local_domain }}
    {{ manager_node_ip }} {{ pihole_container_name }}.{{ local_domain }}
    {{ manager_node_ip }} {{ portainer_container_name }}.{{ local_domain }}
    {{ manager_node_ip }} {{ nginx_proxy_container_name }}.{{ local_domain }}
    {{ manager_node_ip }} {{ openvpn_container_name }}.{{ local_domain }}
    {{ manager_node_ip }} {{ jellyfin_container_name }}.{{ local_domain }}
    EOF
    '
  register: custom_dns
  changed_when: custom_dns.rc == 0

- name: Add line to misc.dnsmasq_lines to fix max concurrent dns queries warning
  ansible.builtin.shell: |
    docker exec {{ pihole_container_id.stdout }} bash -c '
    echo "dns-forward-max=300" >> /etc/dnsmasq.d/misc.dnsmasq_lines
    '
  register: dnsmasq_config
  changed_when: dnsmasq_config.rc == 0

- name: Restart Pi-hole DNS to apply custom DNS entries
  ansible.builtin.shell: |
    docker exec {{ pihole_container_id.stdout }} pihole restartdns
  when: custom_dns.changed

- name: Get Pi-hole statistics
  ansible.builtin.shell: |
    docker exec {{ pihole_container_id.stdout }} pihole -c -j
  register: pihole_stats
  changed_when: false
  failed_when: false

- name: Clean up temporary files
  ansible.builtin.file:
    path: /tmp/configure_adlists.sh
    state: absent

- name: Display Pi-hole access information
  ansible.builtin.debug:
    msg: |
      ‚úÖ Pi-hole is configured successfully!
      
      üåê Access Information (via Swarm ingress - accessible from ANY node):
      Web Interface: http://{{ ansible_host }}:{{ pihole_web_port }}/admin
      DNS Server: {{ ansible_host }}:53
      Password: {{ pihole_web_password }}
      
       Configuration:
      - Custom DNS entries configured for .{{ local_domain }} domains
      - Running on node: {{ pihole_node.stdout }}
      - Container ID: {{ pihole_container_id.stdout }}
      - Block lists configured and gravity updated