---
# Deploy Docker Compose stacks
- name: Create proxy network for services (Swarm overlay)
  community.docker.docker_network:
    name: proxy-network
    state: present
    driver: overlay
    attachable: true
    scope: swarm
    ipam_config:
      - subnet: "172.20.0.0/16"
        gateway: "172.20.0.1"

- name: Verify proxy network exists
  ansible.builtin.command:
    cmd: docker network inspect proxy-network
  register: network_check
  changed_when: false

- name: Display network information
  ansible.builtin.debug:
    msg: |
      ✅ proxy-network created successfully
      Network ID: {{ (network_check.stdout | from_json)[0].Id[:12] }}
      Driver: {{ (network_check.stdout | from_json)[0].Driver }}
      Subnet: {{ (network_check.stdout | from_json)[0].IPAM.Config[0].Subnet }}

- name: Create temporary directory for stack compose files
  ansible.builtin.file:
    path: /tmp/docker-stacks
    state: directory
    mode: '0755'

- name: Template stack compose files
  ansible.builtin.template:
    src: "{{ item.compose_template }}"
    dest: "/tmp/docker-stacks/{{ item.name }}.yml"
    mode: '0644'
  loop: "{{ portainer_stacks }}"

- name: Ensure Jellyfin volumes exist on midnight-laptop
  ansible.builtin.shell: |
    docker volume inspect jellyfin_config >/dev/null 2>&1 || docker volume create jellyfin_config
    docker volume inspect jellyfin_cache >/dev/null 2>&1 || docker volume create jellyfin_cache
  delegate_to: lenovo_server
  register: jellyfin_volume_check
  changed_when: "'jellyfin_config' in jellyfin_volume_check.stdout or 'jellyfin_cache' in jellyfin_volume_check.stdout"

- name: Get Portainer authentication token
  ansible.builtin.uri:
    url: "https://{{ ansible_host }}:{{ portainer_host_port }}/api/auth"
    method: POST
    body_format: json
    body:
      username: "admin"
      password: "{{ portainer_admin_password }}"
    validate_certs: false
    status_code: [200]
  register: portainer_auth
  retries: 3
  delay: 5

- name: Get Portainer endpoint ID
  ansible.builtin.uri:
    url: "https://{{ ansible_host }}:{{ portainer_host_port }}/api/endpoints"
    method: GET
    headers:
      Authorization: "Bearer {{ portainer_auth.json.jwt }}"
    validate_certs: false
    status_code: [200]
  register: portainer_endpoints

- name: Set Portainer endpoint ID
  ansible.builtin.set_fact:
    portainer_endpoint_id: "{{ portainer_endpoints.json[0].Id }}"

- name: Get Docker Swarm ID
  ansible.builtin.shell: docker info --format '{% raw %}{{.Swarm.Cluster.ID}}{% endraw %}'
  register: swarm_id_result
  changed_when: false

- name: Read all stack compose files
  ansible.builtin.slurp:
    src: "/tmp/docker-stacks/{{ item.name }}.yml"
  loop: "{{ portainer_stacks }}"
  register: stack_file_contents

- name: Get existing stacks from Portainer
  ansible.builtin.uri:
    url: "https://{{ ansible_host }}:{{ portainer_host_port }}/api/stacks"
    method: GET
    headers:
      Authorization: "Bearer {{ portainer_auth.json.jwt }}"
    validate_certs: false
    status_code: [200]
  register: existing_stacks

- name: Deploy new stacks via Portainer API
  ansible.builtin.uri:
    url: "https://{{ ansible_host }}:{{ portainer_host_port }}/api/stacks/create/swarm/string?endpointId={{ portainer_endpoint_id }}"
    method: POST
    headers:
      Authorization: "Bearer {{ portainer_auth.json.jwt }}"
    body_format: json
    body:
      name: "{{ item.item.name }}"
      stackFileContent: "{{ item.content | b64decode }}"
      swarmID: "{{ swarm_id_result.stdout }}"
    validate_certs: false
    status_code: [200]
  loop: "{{ stack_file_contents.results }}"
  when: existing_stacks.json | selectattr('Name', 'equalto', item.item.name) | list | length == 0
  register: stack_create_results
  failed_when: false

- name: Update existing stacks via Portainer API
  ansible.builtin.uri:
    url: "https://{{ ansible_host }}:{{ portainer_host_port }}/api/stacks/{{ (existing_stacks.json | selectattr('Name', 'equalto', item.item.name) | list)[0].Id }}?endpointId={{ portainer_endpoint_id }}"
    method: PUT
    headers:
      Authorization: "Bearer {{ portainer_auth.json.jwt }}"
    body_format: json
    body:
      stackFileContent: "{{ item.content | b64decode }}"
      prune: false
    validate_certs: false
    status_code: [200]
  loop: "{{ stack_file_contents.results }}"
  when: existing_stacks.json | selectattr('Name', 'equalto', item.item.name) | list | length > 0
  register: stack_update_results
  failed_when: false

- name: Display stack deployment summary
  ansible.builtin.debug:
    msg: |
      ✅ All stacks deployed via Portainer API for full visibility!
      
      Created Stacks:
      {{ stack_create_results.results | selectattr('status', 'defined') | selectattr('status', 'equalto', 200) | map(attribute='item.item.name') | list | join(', ') | default('None') }}
      
      Updated Stacks:
      {{ stack_update_results.results | selectattr('status', 'defined') | selectattr('status', 'equalto', 200) | map(attribute='item.item.name') | list | join(', ') | default('None') }}
      
      All containers should now be visible in Portainer UI.
