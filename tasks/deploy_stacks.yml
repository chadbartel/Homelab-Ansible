---
# Deploy Docker Compose stacks
- name: Create proxy network for services (Swarm overlay)
  community.docker.docker_network:
    name: proxy-network
    state: present
    driver: overlay
    attachable: true
    scope: swarm
    ipam_config:
      - subnet: "172.20.0.0/16"
        gateway: "172.20.0.1"

- name: Verify proxy network exists
  ansible.builtin.command:
    cmd: docker network inspect proxy-network
  register: network_check
  changed_when: false

- name: Display network information
  ansible.builtin.debug:
    msg: |
      âœ… proxy-network created successfully
      Network ID: {{ (network_check.stdout | from_json)[0].Id[:12] }}
      Driver: {{ (network_check.stdout | from_json)[0].Driver }}
      Subnet: {{ (network_check.stdout | from_json)[0].IPAM.Config[0].Subnet }}

- name: Create temporary directory for stack compose files
  ansible.builtin.file:
    path: /tmp/docker-stacks
    state: directory
    mode: '0755'

- name: Template stack compose files
  ansible.builtin.template:
    src: "{{ item.compose_template }}"
    dest: "/tmp/docker-stacks/{{ item.name }}.yml"
    mode: '0644'
  loop: "{{ portainer_stacks }}"

- name: Deploy stacks to Docker Swarm
  ansible.builtin.shell:
    cmd: "docker stack deploy -c /tmp/docker-stacks/{{ item.name }}.yml {{ item.name }}"
  loop: "{{ portainer_stacks }}"
  register: stack_deployment_result

- name: Display stack deployment results
  ansible.builtin.debug:
    msg: |
      Stack: {{ item.item.name }}
      Status: {{ 'Deployed' if item.changed else 'Already up to date' }}
      Output: {{ item.stdout }}
  loop: "{{ stack_deployment_result.results }}"
