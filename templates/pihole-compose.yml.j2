---
version: "3.8"

services:
  pihole:
    hostname: {{ pihole_container_name }}
    image: {{ pihole_image }}
    ports:
      - "445:443/tcp"
      - "53:53/tcp"
      - "53:53/udp"
      - "{{ pihole_web_port }}:{{ pihole_dns_port | default(80) }}/tcp"
    environment:
      TZ: '{{ timezone }}'
      FTLCONF_webserver_api_password: '{{ pihole_web_password }}'
      # Upstream DNS servers (prevents query failures and timeouts)
      FTLCONF_dns_upstreams: '{{ pihole_upstream_dns_servers | default(["1.1.1.1", "8.8.8.8"]) | join(";") }}'
      # DNS listening mode - 'local' only listens on container network (more secure than 'all')
      FTLCONF_dns_listeningMode: '{{ pihole_dns_listening_mode | default("local") }}'
      # Rate limiting configuration (prevents "Client X has been rate-limited" errors)
      # Note: These are startup defaults; can be overridden via API at runtime
      FTLCONF_dns_rateLimit_count: '{{ pihole_rate_limit_count | default(2000) }}'
      FTLCONF_dns_rateLimit_interval: '{{ pihole_rate_limit_interval | default(60) }}'
      FTLCONF_dns_revServers: 'true,192.168.1.0/24,192.168.1.1'
      FTLCONF_dns_dnssec: 'false'
      FTLCONF_dns_hosts: |
        {{ manager_node_ip }} {{ pihole_container_name }}.{{ local_domain }}
        {{ manager_node_ip }} {{ portainer_container_name }}.{{ local_domain }}
        {{ manager_node_ip }} {{ nginx_proxy_container_name }}.{{ local_domain }}
        {{ manager_node_ip }} {{ openvpn_container_name }}.{{ local_domain }}
        {{ manager_node_ip }} {{ jellyfin_container_name }}.{{ local_domain }}
      FTLCONF_dhcp_router: '{{ gateway_ip }}'
      FTLCONF_dns_domainNeeded: 'true'
    volumes:
      - pihole_etc:/etc/pihole
      - pihole_dnsmasq:/etc/dnsmasq.d
    cap_add:
      - NET_ADMIN
    networks:
      - proxy-network
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.hostname == {{ pihole_target_host | default('midnight-laptop') }}

volumes:
  pihole_etc:
  pihole_dnsmasq:

networks:
  proxy-network:
    external: true